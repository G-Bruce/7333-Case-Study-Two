---
title: "Quantifying_casestudy4"
author: "Brandon"
date: "September 14, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(XML)
ubase = "http://www.cherryblossom.org/"

#### From text
menURLs = 
  c("cb99m.htm", 
    "cb003m.htm", 
    "results/2001/oof_m.html",
    "results/2002/oofm.htm", 
    "results/2003/CB03-M.HTM",
    "results/2004/men.htm", 
    "results/2005/CB05-M.htm", 
    "results/2006/men.htm", 
    "results/2007/men.htm", 
    "results/2008/men.htm", 
    "results/2009/09cucb-M.htm",
    "results/2010/2010cucb10m-m.htm", 
    "results/2011/2011cucb10m-m.htm",
    "results/2012/2012cucb10m-m.htm")
####

#### Revised URLS
menURLsV2 = 
  c("results/1999/cb99m.html", #"cb99m.htm"
    "results/2000/Cb003m.htm", #"cb003m.htm"
    "results/2001/oof_m.html", #"results/2001/oof_m.html"
    "results/2002/oofm.htm", #"results/2002/oofm.htm"
    "results/2003/CB03-M.HTM", #"results/2003/CB03-M.HTM"
    "results/2004/men.htm", #"results/2004/men.htm"
    "results/2005/CB05-M.htm", #"results/2005/CB05-M.htm"
    "results/2006/men.htm", #"results/2006/men.htm"
    "results/2007/men.htm", #"results/2007/men.htm"
    "results/2008/men.htm", #"results/2008/men.htm"
    "results/2009/09cucb-M.htm", #"results/2009/09cucb-M.htm"
    "results/2010/2010cucb10m-m.htm", #"results/2010/2010cucb10m-m.htm"
    "results/2011/2011cucb10m-m.htm", #"results/2011/2011cucb10m-m.htm"
    "results/2012/2012cucb10m-m.htm" #"results/2012/2012cucb10m-m.htm"
    )
####

#### Text URLS
urls = paste(ubase, menURLs, sep="")
urls[1:4]

#### Revised URLS
urlsV2 = paste(ubase, menURLsV2, sep="")
urlsV2[1:4]

```

###DO NOT USE:  This is the function causing problems with 1999 giving back just one 'lenght'.  need to move the next function that properly normalizes for 1999

#### Textbook Function
extractResTable =
  #
  # Retrieve data from web site, 
  # find the preformatted text,
  # and write lines or return as a character vector.
  #
  function(url = "http://www.cherryblossom.org/results/2009/09cucb-F.htm",
           year = 1999, sex = "male", file = NULL)
  {
    #added encoding for windows users who get an "A" symbol
    doc = htmlParse(url)    
    #doc = htmlParse(url, encoding="UTF-8")
    
    if (year == 2000) {
      # Get preformatted text from 4th font element
      # The top file is ill formed so the <pre> search doesn't work.
      ff = getNodeSet(doc, "//font")
      txt = xmlValue(ff[[4]])
      els = strsplit(txt, "\r\n")[[1]]
    }
    else if (year == 2009 & sex == "male") {
      # Get preformatted text from <div class="Section1"> element
      # Each line of results is in a <pre> element
      div1 = getNodeSet(doc, "//div[@class='Section1']")
      pres = getNodeSet(div1[[1]], "//pre")
      els = sapply(pres, xmlValue)
    }
    else {
      # Get preformatted text from <pre> elements
      pres = getNodeSet(doc, "//pre")
      txt = xmlValue(pres[[1]])
      els = strsplit(txt, "\r\n")[[1]]   
    } 
    
    if (is.null(file)) return(els)
    # Write the lines as a text file.
    writeLines(els, con = file)
  }

```{r}

#### Revised Function
extractResTableV2 =
  #
  # Retrieve data from web site, 
  # find the preformatted text,
  # and write lines or return as a character vector.
  #
  function(url = "http://www.cherryblossom.org/results/2009/09cucb-F.htm",
           year = 1999, sex = "male", file = NULL)
  {
    #added encoding for windows users who get an "A" symbol
    doc = htmlParse(url, encoding="UTF-8")
    
    if (year == 2000) {
      # Get preformatted text from 4th font element
      # The top file is ill formed so the <pre> search doesn't work.
      ff = getNodeSet(doc, "//font")
      txt = xmlValue(ff[[4]])
      els = strsplit(txt, "\r\n")[[1]]
    }
    else if (year == 2009 & sex == "male") {
      # Get preformatted text from <div class="Section1"> element
      # Each line of results is in a <pre> element
      div1 = getNodeSet(doc, "//div[@class='Section1']")
      pres = getNodeSet(div1[[1]], "//pre")
      els = sapply(pres, xmlValue)
    }
    else if (year == 1999 & sex == "male") { # have to add this else if statement
      # Get preformatted text from <pre> elements
      pres = getNodeSet(doc, "//pre")
      txt = xmlValue(pres[[1]])
      els = strsplit(txt, "\n")[[1]]   
    } 
    else {
      # Get preformatted text from <pre> elements
      pres = getNodeSet(doc, "//pre")
      txt = xmlValue(pres[[1]])
      els = strsplit(txt, "\r\n")[[1]]   
    } 
    
    if (is.null(file)) return(els)
    # Write the lines as a text file.
    writeLines(els, con = file)
  }
```
#### Individual Input Components for Testing
#url <- 'http://www.cherryblossom.org/results/1999/cb99m.html'
#year <- 1999
#sex <- "male"
#file <- NULL
####

#### Textbook example with (1) URL
####df <- extractResTable(url = "http://www.cherryblossom.org/results/2000/Cb003m.htm", year = 2000, sex = "male", file = NULL)

#### Textbook extraction of Male tables (results in an error)
##years = 1999:2012
##menTables = mapply(extractResTable, url = urls, year = years)
##names(menTables) = years
##sapply(menTables, length)
```{r}
urls[1]
urlsV2[1]
```

###The following function isn't needed - done to compare/constrast in order to assess modifications needed to used function for difference in 1999 data

#### Modified textbook extraction of Male tables (results in 1999 having (1) record)
menTables = mapply(extractResTable, url = urlsV2, year = years)
names(menTables) = years
sapply(menTables, length)

#### Code to compare and contrast the format of two different years
substr(menTables$'1999', start = 1, stop = 100)
menTables$'2000'[1:10]


```{r}
###Correct function for 1999 normalization
#### Corrected function to pull down Male tables with consistent format
menTablesV2 = mapply(extractResTableV2, url = urlsV2, year = years)
names(menTablesV2) = years
sapply(menTablesV2, length)

#### Confirmation that the 1999 and other years have consistent formatting
#####menTablesV2$'1999'[1:10]
#####menTablesV2[[2]][1:10]
#####menTablesV2[[3]][1:10]
#####menTablesV2[[4]][1:10]
#####menTablesV2[[5]][1:10]
#####menTablesV2[[6]][1:10]
#####menTablesV2[[7]][1:10]
#####menTablesV2[[8]][1:10]
#### Save the outputs
save(menTablesV2, file = "CBMenTextTables_Houssaye.rda")

```


THE FOLLOWING STEPS WERE NOT UTLIZED, BUT WERE EXPLORED IN ORDER TO UNDERSTAND THE BUILT AND UTILIZED FUNCTION

#We have now read the individual years into the file and saved the individual years into the a singular .RDA file.  It is now time to extract the data into tables that are consistent for row location, etc.  May also need to create a year/year race column.

##create seperate file for each men's year and check the header to confirm

menst1999 = menTablesV2[[1]]
menst2000 = menTablesV2[[2]]
menst2001 = menTablesV2[[3]]
menst2002 = menTablesV2[[4]]
menst2003 = menTablesV2[[5]]
menst2004 = menTablesV2[[6]]
menst2005 = menTablesV2[[7]]
menst2006 = menTablesV2[[8]]
menst2007 = menTablesV2[[9]]
menst2008 = menTablesV2[[10]]
menst2009 = menTablesV2[[11]]
menst2010 = menTablesV2[[12]]
menst2011 = menTablesV2[[13]]
menst2012 = menTablesV2[[14]]
```
#Explore & extract 1999 data first

menst1999[1:10]

eqIndex = grep("^===", menst1999)
eqIndex

first3 = substr(menst1999, 1, 3)
which(first3 == "===")

spacerRow = menst1999[eqIndex]
headerRow = menst1999[eqIndex - 1]
body = menst1999[ -(1:eqIndex) ]

headerRow = tolower(headerRow)

ageStart = regexpr("ag", headerRow)
ageStart

age = substr(body, start = ageStart, stop = ageStart + 1)
head(age)

summary(as.numeric(age))

blankLocs = gregexpr(" ", spacerRow)
blankLocs

searchLocs = c(0, blankLocs[[1]])

Values = mapply(substr, list(body), 
                start = searchLocs[ -length(searchLocs)] + 1, 
                stop = searchLocs[ -1 ] - 1)

findColLocs = function(spacerRow) {

  spaceLocs = gregexpr(" ", spacerRow)[[1]]
  rowLength = nchar(spacerRow)

  if (substring(spacerRow, rowLength, rowLength) != " ")
    return( c(0, spaceLocs, rowLength + 1))
  else return(c(0, spaceLocs))
}

selectCols = 
function(colNames, headerRow, searchLocs) 
{
  sapply(colNames, 
         function(name, headerRow, searchLocs)
         {
           startPos = regexpr(name, headerRow)[[1]]
           if (startPos == -1) 
             return( c(NA, NA) )
    
           index = sum(startPos >= searchLocs)
           c(searchLocs[index] + 1, searchLocs[index + 1] - 1)
         },
         headerRow = headerRow, searchLocs = searchLocs )
}

searchLocs = findColLocs(spacerRow)
ageLoc = selectCols("ag", headerRow, searchLocs) 
ages = mapply(substr, list(body), 
              start = ageLoc[1,], stop = ageLoc[2, ])

summary(as.numeric(ages))

shortColNames = c("name", "home", "ag", "gun", "net", "time")

locCols = selectCols(shortColNames, headerRow, searchLocs)

Values = mapply(substr, list(body), start = locCols[1, ], 
                stop = locCols[2, ])

class(Values)

colnames(Values) = shortColNames
head(Values)

tail(Values)[ , 1:3]


```{r}

extractVariables = 
  function(file, varNames =c("name", "home", "ag", "gun",
                             "net", "time"))
{
      
  eqIndex = grep("^===", file)
  spacerRow = file[eqIndex] 
  headerRow = tolower(file[ eqIndex - 1 ])
  body = file[ -(1 : eqIndex) ]
  searchLocs = findColLocs(spacerRow)
  locCols = selectCols(varNames, headerRow, searchLocs)

  Values = mapply(substr, list(body), start = locCols[1, ], 
                  stop = locCols[2, ])
  colnames(Values) = varNames
  
  invisible(Values)
  }


menResMat = lapply(menTablesV2, extractVariables)
length(menResMat)

sapply(menResMat, nrow)

## looking at results and it appears we have peeled out headers.  Now time to explore individual years

```

```{r}
#1.  Seperate Years into individual DF.

m1999 = as.data.frame(menResMat[[1]])
m2000 = as.data.frame(menResMat[[2]])
m2001 = as.data.frame(menResMat[[3]])
m2002 = as.data.frame(menResMat[[4]])
m2003 = as.data.frame(menResMat[[5]])
m2004 = as.data.frame(menResMat[[6]])
m2005 = as.data.frame(menResMat[[7]])
m2006 = as.data.frame(menResMat[[8]])
m2007 = as.data.frame(menResMat[[9]])
m2008 = as.data.frame(menResMat[[10]])
m2009 = as.data.frame(menResMat[[11]])
m2010 = as.data.frame(menResMat[[12]])
m2011 = as.data.frame(menResMat[[13]])
m2012 = as.data.frame(menResMat[[14]])

#2.  Create new variable for year

m1999$newcolumn = 1999
m2000$newcolumn = 2000
m2001$newcolumn = 2001
m2002$newcolumn = 2002
m2003$newcolumn = 2003
m2004$newcolumn = 2004
m2005$newcolumn = 2005
m2006$newcolumn = 2006
m2007$newcolumn = 2007
m2008$newcolumn = 2008
m2009$newcolumn = 2009
m2010$newcolumn = 2010
m2011$newcolumn = 2011
m2012$newcolumn = 2012

## do not do this step unless you accidentally created an extra column for 1999 file

m1999 <- m1999[ -c(8)]

names(m1999)[7] <- "Year"
names(m2000)[7] <- "Year"
names(m2001)[7] <- "Year"
names(m2002)[7] <- "Year"
names(m2003)[7] <- "Year"
names(m2004)[7] <- "Year"
names(m2005)[7] <- "Year"
names(m2006)[7] <- "Year"
names(m2007)[7] <- "Year"
names(m2008)[7] <- "Year"
names(m2009)[7] <- "Year"
names(m2010)[7] <- "Year"
names(m2011)[7] <- "Year"
names(m2012)[7] <- "Year"







```


